<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ„Ø®ÙŠØµ Ù…Ø³ØªÙ†Ø¯Ø§Øª PDF Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // SpÃ©cifier le workerSrc pour PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7fafc; /* bg-gray-100 */
        }
        .loader {
            border: 6px solid #e5e7eb; /* bg-gray-200 */
            border-top: 6px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-file-input::before {
            content: 'Ø§Ø®ØªØ± Ù…Ù„Ù PDF';
            display: inline-block;
            background: #3b82f6; /* bg-blue-500 */
            color: white;
            border: 1px solid #3b82f6;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 600; /* font-semibold */
            margin-left: 10px; /* Pour RTL, cela le pousse vers la droite */
        }
        .custom-file-input:hover::before {
            background: #2563eb; /* bg-blue-600 */
        }
        .custom-file-input:active::before {
            background: #1d4ed8; /* bg-blue-700 */
        }
        #summaryOutput, #extractedTextPreview {
            white-space: pre-wrap; /* Conserver les sauts de ligne et les espaces */
            text-align: justify;
        }
        .copy-button {
            transition: background-color 0.3s ease;
        }
        /* Style pour les boutons radio personnalisÃ©s (optionnel, Tailwind Forms peut mieux gÃ©rer cela) */
        .form-radio {
            appearance: none;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            height: 1rem;
            width: 1rem;
            color: #3b82f6; /* text-blue-600 */
            background-color: #fff;
            border-color: #6b7280; /* border-gray-500 */
            border-width: 1px;
            border-radius: 100%;
        }
        .form-radio:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-inset: var(--tw-empty,/*!*/ /*!*/);
            --tw-ring-offset-width: 2px;
            --tw-ring-offset-color: #fff;
            --tw-ring-color: #3b82f6; /* ring-blue-600 */
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            border-color: #3b82f6; /* border-blue-600 */
        }
        .form-radio:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
            border-color: transparent;
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">ØªÙ„Ø®ÙŠØµ Ù…Ø³ØªÙ†Ø¯Ø§Øª PDF Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h1>
            <p class="text-gray-600 mt-2">Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù PDF ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ø¯Ù‚ÙŠÙ‚ Ù„Ù…Ø­ØªÙˆØ§Ù‡ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</p>
            </header>

        <main class="bg-white p-6 md:p-8 rounded-xl shadow-2xl">
            <div class="mb-6">
                <label for="pdfFile" class="block text-lg font-semibold text-gray-700 mb-2">Ø§Ø®ØªØ± Ù…Ù„Ù PDF:</label>
                <div class="flex items-center">
                    <input type="file" id="pdfFile" accept=".pdf" class="custom-file-input text-gray-700 text-sm">
                    <span id="fileName" class="text-gray-500 mr-3">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ù</span>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-lg font-semibold text-gray-700 mb-2">Ø·ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
                <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-6 sm:space-x-reverse space-y-2 sm:space-y-0">
                    <div class="flex items-center">
                        <input type="radio" id="summaryLengthShort" name="summaryLength" value="short" class="form-radio ml-2 focus:ring-blue-500 text-blue-600 border-gray-300" checked>
                        <label for="summaryLengthShort" class="text-gray-700">Ù…ÙˆØ¬Ø² Ù‚ØµÙŠØ± (2-3 Ø¬Ù…Ù„)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="summaryLengthMedium" name="summaryLength" value="medium" class="form-radio ml-2 focus:ring-blue-500 text-blue-600 border-gray-300">
                        <label for="summaryLengthMedium" class="text-gray-700">Ù…Ù„Ø®Øµ Ù…ØªÙˆØ³Ø· (ÙÙ‚Ø±Ø© Ø£Ùˆ Ø§Ø«Ù†ØªÙŠÙ†)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="summaryLengthDetailed" name="summaryLength" value="detailed" class="form-radio ml-2 focus:ring-blue-500 text-blue-600 border-gray-300">
                        <label for="summaryLengthDetailed" class="text-gray-700">Ù…Ù„Ø®Øµ Ù…ÙØµÙ„ (Ø´Ø§Ù…Ù„)</label>
                    </div>
                </div>
            </div>

            <button id="summarizeButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                Ù„Ø®Øµ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù†
            </button>

            <div id="statusMessages" class="mt-6 text-center">
                <div id="loader" class="loader hidden"></div>
                <p id="loadingMessage" class="text-blue-500 font-semibold hidden"></p>
                <p id="errorMessage" class="text-red-500 font-semibold p-3 bg-red-50 rounded-md hidden"></p>
            </div>

            <div id="extractedTextContainer" class="mt-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b-2 border-gray-200 pb-2">Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† PDF (Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„ 500 Ø­Ø±Ù)</h2>
                <div id="extractedTextPreview" class="p-4 bg-gray-50 rounded-md max-h-40 overflow-y-auto text-sm text-gray-600 border border-gray-200">
                    </div>
            </div>

            <div id="summaryContainer" class="mt-8 hidden">
                <div class="flex justify-between items-center mb-3 border-b-2 border-gray-200 pb-2">
                    <h2 class="text-2xl font-semibold text-gray-700">ğŸ“œ Ø§Ù„Ù…Ù„Ø®Øµ</h2>
                    <button id="copySummaryButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md text-sm shadow-sm copy-button">
                        Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ
                    </button>
                </div>
                <div id="summaryOutput" class="p-4 bg-blue-50 rounded-md text-gray-800 leading-relaxed border border-blue-200">
                    </div>
                <p id="copyMessage" class="text-green-600 text-sm mt-2 text-center hidden">ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ!</p>
            </div>
        </main>
    </div>

    <script>
        // SÃ©lection des Ã©lÃ©ments du DOM
        const pdfFileInput = document.getElementById('pdfFile');
        const fileNameDisplay = document.getElementById('fileName');
        const summarizeButton = document.getElementById('summarizeButton');
        const loader = document.getElementById('loader');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const extractedTextContainer = document.getElementById('extractedTextContainer');
        const extractedTextPreview = document.getElementById('extractedTextPreview');
        const summaryContainer = document.getElementById('summaryContainer');
        const summaryOutput = document.getElementById('summaryOutput');
        const copySummaryButton = document.getElementById('copySummaryButton');
        const copyMessage = document.getElementById('copyMessage');
        const summaryLengthRadios = document.querySelectorAll('input[name="summaryLength"]');


        // Mettre Ã  jour l'affichage du nom du fichier lors de la sÃ©lection
        pdfFileInput.addEventListener('change', () => {
            if (pdfFileInput.files.length > 0) {
                fileNameDisplay.textContent = pdfFileInput.files[0].name;
                summarizeButton.disabled = false;
                clearMessagesAndResults(); // Effacer les anciens messages et rÃ©sultats
            } else {
                fileNameDisplay.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ù';
                summarizeButton.disabled = true;
            }
        });

        summarizeButton.disabled = true; // DÃ©sactiver initialement le bouton

        // Fonction pour afficher l'Ã©tat de chargement
        function showLoading(message) {
            loader.classList.remove('hidden');
            loadingMessage.textContent = message;
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            summarizeButton.disabled = true;
            extractedTextContainer.classList.add('hidden');
            summaryContainer.classList.add('hidden');
            copyMessage.classList.add('hidden');
        }

        // Fonction pour afficher un message d'erreur
        function showError(message) {
            loader.classList.add('hidden');
            loadingMessage.classList.add('hidden');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            // RÃ©activer le bouton seulement si un fichier est sÃ©lectionnÃ©
            summarizeButton.disabled = (pdfFileInput.files.length === 0);
        }

        // Fonction pour effacer tous les messages et rÃ©sultats
        function clearMessagesAndResults() {
            loader.classList.add('hidden');
            loadingMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            extractedTextContainer.classList.add('hidden');
            extractedTextPreview.textContent = '';
            summaryContainer.classList.add('hidden');
            summaryOutput.textContent = '';
            copyMessage.classList.add('hidden');
        }

        // Fonction pour extraire le texte d'un PDF
        async function extractTextFromPdf(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const pdfData = new Uint8Array(event.target.result);
                        // Charger le document PDF
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        let fullText = '';
                        // ItÃ©rer sur chaque page pour en extraire le contenu textuel
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            // Joindre les items de texte de la page
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n\n'; // Ajouter un double saut de ligne entre les pages pour la lisibilitÃ©
                        }
                        resolve(fullText.trim()); // Retourner le texte complet sans espaces superflus
                    } catch (error) {
                        console.error("Erreur lors de l'analyse du PDF:", error);
                        reject("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù PDF. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ§Ù„Ø­ ÙˆØ£Ù† Ù…Ø­ØªÙˆØ§Ù‡ Ù†ØµÙŠ.");
                    }
                };
                reader.onerror = () => {
                    // GÃ©rer les erreurs de lecture du fichier
                    reject("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.");
                };
                reader.readAsArrayBuffer(file); // Lire le fichier comme un ArrayBuffer
            });
        }

        // Fonction pour appeler l'API Gemini pour le rÃ©sumÃ©
        async function getSummaryFromGemini(text, desiredLength) {
            // C'est ici que vous placeriez votre clÃ© API Gemini pour des tests locaux.
            // Pour un site public, cette clÃ© doit Ãªtre protÃ©gÃ©e sur un serveur.
            const apiKey = "AIzaSyBOmFv0f43ZcXK_lAN1kJs8dQ5PrSzskbw"; // <-- Placez votre clÃ© API Gemini ici UNIQUEMENT pour tests locaux.

            if (apiKey === "AIzaSyBOmFv0f43ZcXK_lAN1kJs8dQ5PrSzskbw" && !(typeof __APP_ID__ !== 'undefined')) { 
                 console.warn("ClÃ© API Gemini non configurÃ©e pour tests locaux. L'appel API va probablement Ã©chouer si l'environnement ne la fournit pas.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let lengthInstruction = "";
            if (desiredLength === "short") {
                lengthInstruction = "ÙŠØ±Ø¬Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ù…Ù„Ø®Øµ Ù…ÙˆØ¬Ø² Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø­Ø¯ÙˆØ¯ 2 Ø¥Ù„Ù‰ 3 Ø¬Ù…Ù„ Ø±Ø¦ÙŠØ³ÙŠØ©.";
            } else if (desiredLength === "medium") {
                lengthInstruction = "ÙŠØ±Ø¬Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ù…Ù„Ø®Øµ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·ÙˆÙ„ØŒ ÙŠØªÙƒÙˆÙ† Ù…Ù† ÙÙ‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ ÙÙ‚Ø±ØªÙŠÙ†ØŒ ÙŠØºØ·ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.";
            } else if (desiredLength === "detailed") {
                lengthInstruction = "ÙŠØ±Ø¬Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ù…Ù„Ø®Øµ Ù…ÙØµÙ„ ÙˆØ´Ø§Ù…Ù„ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†ØŒ ÙŠØºØ·ÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ù‡Ø§Ù…Ø© Ù„Ù„Ù†Øµ.";
            }

            const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ ØªÙ„Ø®ÙŠØµ Ø§Ù„Ù†ØµÙˆØµ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©. Ù„Ù‚Ø¯ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ù† Ù…Ø³ØªÙ†Ø¯ PDF. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ØªÙ‚Ø¯ÙŠÙ… Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ ÙˆØ¯Ù‚ÙŠÙ‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰. ${lengthInstruction} ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ±ÙƒØ² Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø§Ù„Ø­Ø¬Ø¬ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠØ©ØŒ Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©ØŒ ÙˆØ§Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬Ø§Øª Ø§Ù„Ù‡Ø§Ù…Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ÙˆØ¶ÙˆØ¹ÙŠØ© Ø§Ù„Ù†Øµ ÙˆØªØ¬Ù†Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© Ø£Ùˆ Ø¢Ø±Ø§Ø¦Ùƒ Ø§Ù„Ø´Ø®ØµÙŠØ©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ø®Øµ ÙˆØ§Ø¶Ø­Ù‹Ø§ØŒ Ù…Ù†Ø¸Ù…Ù‹Ø§ØŒ ÙˆØ³Ù‡Ù„ Ø§Ù„ÙÙ‡Ù… Ù„Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠ. Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØ¶Ù…ÙŠÙ† Ø£ÙŠ Ø¹Ø¨Ø§Ø±Ø§Øª Ù…Ø«Ù„ "Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ ÙŠØªØ­Ø¯Ø« Ø¹Ù†" Ø£Ùˆ "Ø§Ù„Ù…Ù„Ø®Øµ Ù‡Ùˆ". Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„ØªÙ„Ø®ÙŠØµ.\n\nØ§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:\n${text}`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }]
                };
                // Envoyer la requÃªte Ã  l'API Gemini
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // GÃ©rer les rÃ©ponses non-OK de l'API
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("DonnÃ©es d'erreur de l'API:", errorData);
                    let errorMessageDetail = errorData?.error?.message || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.';
                    if (response.status === 400 && errorData?.error?.message.toLowerCase().includes("api key not valid")) {
                        errorMessageDetail = "Ù…ÙØªØ§Ø­ API Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù….";
                    } else if (response.status === 403) {
                         errorMessageDetail = "Ø·Ù„Ø¨ Ù…Ø±ÙÙˆØ¶ Ù…Ù† Ø®Ø§Ø¯Ù… Gemini. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø© Ù…Ø¹ Ù…ÙØªØ§Ø­ API Ø£Ùˆ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.";
                    }
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}. ${errorMessageDetail}`);
                }

                const result = await response.json();

                // VÃ©rifier la structure de la rÃ©ponse et extraire le texte du rÃ©sumÃ©
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Structure de rÃ©ponse API inattendue:", result);
                    throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Gemini API Ø£Ùˆ Ø£Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©.");
                }
            } catch (error) {
                console.error("Erreur lors de l'appel Ã  l'API Gemini:", error);
                throw new Error(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ù† Gemini: ${error.message}`);
            }
        }

        // Ã‰couteur d'Ã©vÃ©nement pour le bouton de rÃ©sumÃ©
        summarizeButton.addEventListener('click', async () => {
            const file = pdfFileInput.files[0];
            // VÃ©rifier si un fichier est sÃ©lectionnÃ©
            if (!file) {
                showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            // VÃ©rifier si le fichier est bien un PDF
            if (file.type !== "application/pdf") {
                showError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨ØµÙŠØºØ© PDF ÙÙ‚Ø·.");
                return;
            }

            let selectedLength = "short"; // Valeur par dÃ©faut
            for (const radio of summaryLengthRadios) {
                if (radio.checked) {
                    selectedLength = radio.value;
                    break;
                }
            }

            clearMessagesAndResults(); // Effacer les messages prÃ©cÃ©dents
            showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ù†Øµ Ù…Ù† Ù…Ù„Ù PDF...");

            try {
                // Extraire le texte du PDF
                const extractedText = await extractTextFromPdf(file);
                if (!extractedText || extractedText.trim().length === 0) {
                    showError("Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† Ø§Ø³ØªØ®Ù„Ø§Øµ Ø£ÙŠ Ù†Øµ Ù…Ù† Ù…Ù„Ù PDF. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù ØµÙˆØ±Ø© Ù…Ù…Ø³ÙˆØ­Ø© Ø¶ÙˆØ¦ÙŠØ§Ù‹ØŒ ÙØ§Ø±ØºØ§Ù‹ØŒ Ø£Ùˆ Ù…Ø­Ù…ÙŠØ§Ù‹.");
                    return;
                }

                // Afficher un aperÃ§u du texte extrait
                extractedTextPreview.textContent = extractedText.substring(0, 500) + (extractedText.length > 500 ? "..." : ""); // AperÃ§u des 500 premiers caractÃ¨res
                extractedTextContainer.classList.remove('hidden');

                showLoading("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...");
                // Obtenir le rÃ©sumÃ© via l'API Gemini
                const summary = await getSummaryFromGemini(extractedText, selectedLength);

                // Afficher le rÃ©sumÃ© et le conteneur du rÃ©sumÃ©
                summaryOutput.innerHTML = summary.replace(/\n/g, '<br>'); // Conserver les sauts de ligne du rÃ©sumÃ©
                summaryContainer.classList.remove('hidden');
                loader.classList.add('hidden'); // Cacher le chargeur
                loadingMessage.classList.add('hidden'); // Cacher le message de chargement
                summarizeButton.disabled = false; // RÃ©activer le bouton de rÃ©sumÃ©

            } catch (error) {
                // GÃ©rer les erreurs survenues pendant le processus de rÃ©sumÃ©
                console.error("Erreur du processus de rÃ©sumÃ©:", error);
                showError(error.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ„Ø®ÙŠØµ.");
            }
        });

        // Ã‰couteur d'Ã©vÃ©nement pour le bouton "Copier le rÃ©sumÃ©"
        copySummaryButton.addEventListener('click', () => {
            const summaryText = summaryOutput.innerText; // Obtenir le texte brut du rÃ©sumÃ©
            if (navigator.clipboard && window.isSecureContext) { // Utiliser l'API Clipboard si disponible et sÃ©curisÃ©e
                navigator.clipboard.writeText(summaryText)
                    .then(() => {
                        copyMessage.textContent = 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­!';
                        copyMessage.classList.remove('hidden');
                        setTimeout(() => copyMessage.classList.add('hidden'), 2000); // Cacher le message aprÃ¨s 2 secondes
                    })
                    .catch(err => {
                        console.error('Erreur lors de la copie du rÃ©sumÃ© (API Clipboard):', err);
                        copyMessage.textContent = 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹.';
                        copyMessage.classList.remove('hidden');
                        copyMessage.classList.replace('text-green-600', 'text-red-600');
                        setTimeout(() => {
                             copyMessage.classList.add('hidden');
                             copyMessage.classList.replace('text-red-600', 'text-green-600');
                        }, 3000);
                    });
            } else { // Solution de repli pour les navigateurs plus anciens ou contextes non sÃ©curisÃ©s
                const textArea = document.createElement("textarea");
                textArea.value = summaryText;
                textArea.style.position = "fixed"; // EmpÃªcher le dÃ©filement vers le bas de la page
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyMessage.textContent = 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ù†Ø¬Ø§Ø­!';
                    copyMessage.classList.remove('hidden');
                    setTimeout(() => copyMessage.classList.add('hidden'), 2000);
                } catch (err) {
                    console.error('Erreur lors de la copie du rÃ©sumÃ© (execCommand):', err);
                    copyMessage.textContent = 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹.';
                    copyMessage.classList.remove('hidden');
                    copyMessage.classList.replace('text-green-600', 'text-red-600');
                    setTimeout(() => {
                        copyMessage.classList.add('hidden');
                        copyMessage.classList.replace('text-red-600', 'text-green-600');
                    }, 3000);
                }
                document.body.removeChild(textArea);
            }
        });

    </script>
</body>
</html>
